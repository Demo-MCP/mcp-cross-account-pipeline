name: MCP Cross-Account Analysis

on:
  issue_comment:
    types: [created]

jobs:
  analyze:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/analyze')
    runs-on: ubuntu-latest
    
    steps:
    - name: Parse Command
      id: parse
      run: |
        COMMENT="${{ github.event.comment.body }}"
        
        # Extract tool type
        if [[ "$COMMENT" =~ /analyze-infrastructure ]]; then
          echo "tool=troubleshoot_cloudformation_deployment" >> $GITHUB_OUTPUT
          echo "stack_name=$(echo "$COMMENT" | grep -oP 'stack=\K[^\s]+')" >> $GITHUB_OUTPUT
        elif [[ "$COMMENT" =~ /troubleshoot-ecs ]]; then
          echo "tool=describe_ecs_service" >> $GITHUB_OUTPUT
          echo "service_name=$(echo "$COMMENT" | grep -oP 'service=\K[^\s]+')" >> $GITHUB_OUTPUT
        fi
        
        # Extract account ID
        if [[ "$COMMENT" =~ account=([0-9]{12}) ]]; then
          echo "account_id=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
        else
          echo "account_id=500330120558" >> $GITHUB_OUTPUT
        fi
        
        # Extract region
        if [[ "$COMMENT" =~ region=([a-z0-9-]+) ]]; then
          echo "region=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
        else
          echo "region=us-east-1" >> $GITHUB_OUTPUT
        fi
    
    - name: Call MCP API
      id: analysis
      run: |
        RESPONSE=$(curl -X POST ${{ secrets.MCP_API_ENDPOINT }} \
          -H "Content-Type: application/json" \
          -H "X-GitHub-Token: ${{ secrets.GITHUB_TOKEN }}" \
          -d '{
            "tool": "${{ steps.parse.outputs.tool }}",
            "account_id": "${{ steps.parse.outputs.account_id }}",
            "region": "${{ steps.parse.outputs.region }}",
            "stack_name": "${{ steps.parse.outputs.stack_name }}",
            "service_name": "${{ steps.parse.outputs.service_name }}",
            "pr_number": "${{ github.event.issue.number }}",
            "repo": "${{ github.repository }}"
          }')
        
        echo "result<<EOF" >> $GITHUB_OUTPUT
        echo "$RESPONSE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Post Results
      uses: actions/github-script@v7
      with:
        script: |
          const result = JSON.parse(`${{ steps.analysis.outputs.result }}`);
          
          const comment = `## ðŸ¤– MCP Analysis Results
          
          **Account**: \`${{ steps.parse.outputs.account_id }}\`
          **Region**: \`${{ steps.parse.outputs.region }}\`
          **Tool**: \`${{ steps.parse.outputs.tool }}\`
          
          ### Results
          ${result.analysis || result.error}
          
          *Analysis completed in ${result.duration_ms}ms by MCP Cross-Account Pipeline*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
