name: MCP Cross-Account Analysis

on:
  issue_comment:
    types: [created]

jobs:
  analyze:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/analyze')
    runs-on: [self-hosted, ecs, mcp]
    
    steps:
    - name: Parse Command
      id: parse
      run: |
        COMMENT="${{ github.event.comment.body }}"
        
        # Extract account ID
        if [[ "$COMMENT" =~ account=([0-9]{12}) ]]; then
          echo "account_id=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
        else
          echo "account_id=500330120558" >> $GITHUB_OUTPUT
        fi
        
        # Extract stack name
        if [[ "$COMMENT" =~ stack=([^\s]+) ]]; then
          echo "stack_name=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
        else
          echo "stack_name=test-stack" >> $GITHUB_OUTPUT
        fi
    
    - name: Run MCP Analysis
      id: analysis
      run: |
        cd /mcp-servers/aws-iac-mcp-server
        export PYTHONPATH="/mcp-servers:/mcp-servers/platform_aws_context:/mcp-servers/aws-iac-mcp-server"
        
        # Test cross-account functionality
        python3 -c "
        import boto3, json
        
        # Test AssumeRole
        sts = boto3.client('sts')
        role_arn = 'arn:aws:iam::${{ steps.parse.outputs.account_id }}:role/McpReadOnlyRole'
        
        try:
            response = sts.assume_role(RoleArn=role_arn, RoleSessionName='GitHub-Actions')
            cf = boto3.client('cloudformation',
                aws_access_key_id=response['Credentials']['AccessKeyId'],
                aws_secret_access_key=response['Credentials']['SecretAccessKey'],
                aws_session_token=response['Credentials']['SessionToken'])
            
            stacks = cf.list_stacks()
            
            result = {
                'success': True,
                'message': f'âœ… Cross-account access successful!\n\n**Account**: ${{ steps.parse.outputs.account_id }}\n**Stack**: ${{ steps.parse.outputs.stack_name }}\n**Found**: {len(stacks[\"StackSummaries\"])} stacks\n**Role**: {response[\"AssumedRoleUser\"][\"Arn\"]}'
            }
        except Exception as e:
            result = {'success': False, 'message': f'âŒ Error: {str(e)}'}
            
        print(json.dumps(result))
        " > /tmp/result.json
        
        echo "result<<EOF" >> $GITHUB_OUTPUT
        cat /tmp/result.json >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Post Results
      uses: actions/github-script@v7
      with:
        script: |
          const result = JSON.parse(`${{ steps.analysis.outputs.result }}`);
          
          const comment = `## ðŸ¤– MCP Cross-Account Analysis
          
          **Command**: \`${{ github.event.comment.body }}\`
          **Account**: \`${{ steps.parse.outputs.account_id }}\`
          **Stack**: \`${{ steps.parse.outputs.stack_name }}\`
          
          ### Results
          ${result.message}
          
          *Analysis completed by self-hosted ECS runner with cross-account MCP pipeline*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
