name: Deploy Infrastructure

on:
  issue_comment:
    types: [created]

jobs:
  deploy:
    if: (github.event.issue.pull_request || github.event.pull_request) && startsWith(github.event.comment.body, '/deploy')
    runs-on: self-hosted
    
    steps:
    - name: Job Start Metrics
      if: always()
      run: |
        echo '{
          "action": "job_start",
          "run_id": "${{ github.run_id }}",
          "repository": "${{ github.repository }}",
          "organization": "${{ github.repository_owner }}",
          "branch": "${{ github.ref_name }}",
          "workflow_name": "${{ github.workflow }}",
          "job_name": "${{ github.job }}",
          "runner_name": "${{ runner.name }}",
          "job_start_time": "'$(date -Iseconds)'",
          "job_status": "RUNNING"
        }' > /tmp/start_payload.json
        
        aws lambda invoke \
          --function-name mcp-metrics-writer \
          --payload file:///tmp/start_payload.json \
          --region us-east-1 \
          /tmp/start_response.json
    
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Extract deploy parameters
      id: params
      run: |
        COMMENT="${{ github.event.comment.body }}"
        STACK_NAME=$(echo "$COMMENT" | sed -n 's|^/deploy \([^ ]*\).*|\1|p')
        echo "stack_name=${STACK_NAME:-sample-demo}" >> $GITHUB_OUTPUT
        
    - name: Deploy CloudFormation stack
      run: |
        aws cloudformation deploy \
          --template-file sample-stack.yaml \
          --stack-name ${{ steps.params.outputs.stack_name }} \
          --parameter-overrides Environment=demo \
          --region us-east-1 \
          --no-fail-on-empty-changeset
          
    - name: Comment on PR
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        curl -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
          -d "{\"body\":\"âœ… Deployed stack **${{ steps.params.outputs.stack_name }}** in region **us-east-1**\"}"

    - name: Job End Metrics
      if: always()
      run: |
        JOB_STATUS="SUCCEEDED"
        if [ "${{ job.status }}" != "success" ]; then
          JOB_STATUS="FAILED"
        fi
        
        echo '{
          "action": "job_end",
          "run_id": "${{ github.run_id }}",
          "repository": "${{ github.repository }}",
          "organization": "${{ github.repository_owner }}",
          "branch": "${{ github.ref_name }}",
          "workflow_name": "${{ github.workflow }}",
          "job_name": "${{ github.job }}",
          "runner_name": "${{ runner.name }}",
          "job_end_time": "'$(date -Iseconds)'",
          "job_status": "'$JOB_STATUS'",
          "job_error_message": "${{ job.status == 'failure' && 'Deployment failed' || '' }}",
          "job_failure_category": "${{ job.status == 'failure' && 'deployment' || '' }}"
        }' > /tmp/end_payload.json
        
        aws lambda invoke \
          --function-name mcp-metrics-writer \
          --payload file:///tmp/end_payload.json \
          --region us-east-1 \
          /tmp/end_response.json
