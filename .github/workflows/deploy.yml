name: Deploy Infrastructure

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  deploy:
    if: (github.event.issue.pull_request || github.event.pull_request) && startsWith(github.event.comment.body, '/deploy')
    runs-on: self-hosted
    
    steps:
    - name: Job Start Metrics
      if: always()
      run: |
        # Store job start time for duration calculation
        echo "JOB_START_TIME=$(date +%s)" >> $GITHUB_ENV
        
        aws lambda invoke \
          --function-name mcp-metrics-writer \
          --cli-binary-format raw-in-base64-out \
          --payload '{"action":"job_start","run_id":"${{ github.run_id }}","repository":"${{ github.repository }}","organization":"${{ github.repository_owner }}","branch":"${{ github.ref_name }}","workflow_name":"${{ github.workflow }}","job_name":"${{ github.job }}","runner_name":"${{ runner.name }}","job_start_time":"'$(date -Iseconds)'","job_status":"RUNNING"}' \
          --region us-east-1 \
          /tmp/start_response.json
    
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Post deployment started with run_id
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        COMMENT="${{ github.event.comment.body }}"
        ENVIRONMENT=$(echo "$COMMENT" | sed -n 's|^/deploy \([^ ]*\).*|\1|p')
        ENVIRONMENT=${ENVIRONMENT:-dev}
        
        curl -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
          -d "{\"body\":\"ðŸš€ **Deployment Started**\\n\\n**Run Details:**\\n- Run ID: \`${{ github.run_id }}\`\\n- Repository: \`${{ github.repository }}\`\\n- Branch: \`${{ github.ref_name }}\`\\n- PR Number: \`${{ github.event.issue.number }}\`\\n- Environment: \`$ENVIRONMENT\`\\n- Region: \`us-east-1\`\\n- Workflow: \`${{ github.workflow }}\`\\n- Status: \`RUNNING\`\\n- Started: $(date -Iseconds)\"}"
      
    - name: Extract deploy parameters
      id: params
      run: |
        COMMENT="${{ github.event.comment.body }}"
        STACK_NAME=$(echo "$COMMENT" | sed -n 's|^/deploy \([^ ]*\).*|\1|p')
        echo "stack_name=${STACK_NAME:-sample-demo}" >> $GITHUB_OUTPUT
        
    - name: Deploy CloudFormation stack
      run: |
        aws cloudformation deploy \
          --template-file sample-stack.yaml \
          --stack-name ${{ steps.params.outputs.stack_name }} \
          --parameter-overrides Environment=demo \
          --region us-east-1 \
          --no-fail-on-empty-changeset
          
    - name: Comment on PR
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        curl -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
          -d "{\"body\":\"âœ… Deployed stack **${{ steps.params.outputs.stack_name }}** in region **us-east-1**\"}"

    - name: Job End Metrics
      if: always()
      run: |
        JOB_STATUS="SUCCEEDED"
        if [ "${{ job.status }}" != "success" ]; then
          JOB_STATUS="FAILED"
        fi
        
        # Calculate job duration in seconds
        JOB_END_TIME=$(date +%s)
        JOB_DURATION=$((JOB_END_TIME - JOB_START_TIME))
        
        aws lambda invoke \
          --function-name mcp-metrics-writer \
          --cli-binary-format raw-in-base64-out \
          --payload '{"action":"job_end","run_id":"${{ github.run_id }}","repository":"${{ github.repository }}","organization":"${{ github.repository_owner }}","branch":"${{ github.ref_name }}","workflow_name":"${{ github.workflow }}","job_name":"${{ github.job }}","runner_name":"${{ runner.name }}","job_end_time":"'$(date -Iseconds)'","job_status":"'$JOB_STATUS'","job_error_message":"${{ job.status == 'failure' && 'Deployment failed' || '' }}","job_failure_category":"${{ job.status == 'failure' && 'deployment' || '' }}","job_duration_seconds":'$JOB_DURATION'}' \
          --region us-east-1 \
          /tmp/end_response.json
